---
import ThemeToggle from './ThemeToggle.astro'

const currentPath = Astro.url.pathname

const navLinks = [
  { href: '/', label: 'Home' },
  { href: '/episodes/', label: 'Episodes' },
  { href: '/about/', label: 'About' },
]
---

<header class="site-header" data-testid="site-header">
  <div class="header-container">
    <a
      href="/"
      class="site-logo"
      aria-label="1g of Code - Home"
      data-testid="site-logo"
    >
      <span class="logo-text">1g of Code</span>
    </a>

    <div class="header-actions">
      <nav
        id="primary-nav"
        class="primary-nav"
        aria-label="Primary navigation"
        data-testid="primary-nav"
      >
        <ul class="nav-list" role="list" data-testid="nav-list">
          {
            navLinks.map((link) => (
              <li>
                <a
                  href={link.href}
                  class:list={[
                    'nav-link',
                    { 'is-active': currentPath === link.href },
                  ]}
                  aria-current={currentPath === link.href ? 'page' : undefined}
                  data-testid={`nav-link-${link.label.toLowerCase()}`}
                >
                  {link.label}
                </a>
              </li>
            ))
          }
        </ul>

        <!-- Button group - positioned differently on mobile vs desktop -->
        <div class="nav-buttons" data-testid="nav-buttons">
          <a
            href="https://twitch.tv/1gOfCode"
            class="twitch-link nav-button-item"
            target="_blank"
            rel="noopener noreferrer"
            aria-label="Watch on Twitch"
            data-testid="twitch-link"
          >
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path
                d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714Z"
              ></path>
            </svg>
            <span class="nav-button-text">Watch on Twitch</span>
          </a>

          <ThemeToggle />
        </div>
      </nav>
    </div>

    <button
      class="nav-toggle"
      aria-expanded="false"
      aria-controls="primary-nav"
      aria-label="Toggle navigation menu"
      data-testid="nav-toggle"
    >
      <span class="hamburger" aria-hidden="true"></span>
    </button>
  </div>
</header>

<script>
  function initNavToggle() {
    const navToggle = document.querySelector('.nav-toggle')
    const primaryNav = document.querySelector('.primary-nav')

    if (!navToggle || !primaryNav) return

    navToggle.addEventListener('click', () => {
      const isExpanded = navToggle.getAttribute('aria-expanded') === 'true'
      navToggle.setAttribute('aria-expanded', String(!isExpanded))
      primaryNav.classList.toggle('is-open')
    })

    // Close menu when clicking outside
    document.addEventListener('click', (event) => {
      const target = event.target as HTMLElement
      if (!target.closest('.site-header')) {
        navToggle.setAttribute('aria-expanded', 'false')
        primaryNav.classList.remove('is-open')
      }
    })

    // Close menu on escape key
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        navToggle.setAttribute('aria-expanded', 'false')
        primaryNav.classList.remove('is-open')
      }
    })
  }

  // Run on initial load
  initNavToggle()

  // Re-run on Astro page transitions
  document.addEventListener('astro:after-swap', initNavToggle)
</script>

<style>
  .site-header {
    position: sticky;
    top: 0;
    z-index: 50;
    background-color: var(--color-bg);
    border-bottom: 1px solid var(--color-border);
    transition:
      background-color var(--transition-base),
      border-color var(--transition-base);
  }

  .header-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: var(--max-width-content);
    margin-inline: auto;
    padding: var(--spacing-md);
  }

  .site-logo {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-weight: 700;
    font-size: var(--font-size-xl);
    color: var(--color-text);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .site-logo:hover {
    color: var(--color-primary);
  }

  .logo-text {
    background: linear-gradient(
      135deg,
      var(--color-primary),
      var(--color-accent)
    );
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* Header Actions - nav + theme toggle container */
  .header-actions {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }

  .twitch-link {
    color: var(--color-text);
    transition:
      color var(--transition-fast),
      background-color var(--transition-fast);
  }

  .twitch-link:hover {
    color: var(--color-twitch);
    background-color: var(--color-bg-secondary);
  }

  .twitch-link:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: -2px;
  }

  .twitch-link svg {
    width: 24px;
    height: 24px;
  }

  /* Navigation Toggle (Hamburger) */
  .nav-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    padding: 0;
    background: transparent;
    border: none;
    cursor: pointer;
    border-radius: var(--border-radius-md);
    transition: background-color var(--transition-fast);
  }

  .nav-toggle:hover {
    background-color: var(--color-bg-secondary);
  }

  .nav-toggle:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  .hamburger {
    position: relative;
    width: 24px;
    height: 2px;
    background-color: var(--color-text);
    border-radius: 2px;
    transition: background-color var(--transition-fast);
  }

  .hamburger::before,
  .hamburger::after {
    content: '';
    position: absolute;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: var(--color-text);
    border-radius: 2px;
    transition: transform var(--transition-base);
  }

  .hamburger::before {
    top: -7px;
  }

  .hamburger::after {
    top: 7px;
  }

  /* Hamburger animation when open */
  .nav-toggle[aria-expanded='true'] .hamburger {
    background-color: transparent;
  }

  .nav-toggle[aria-expanded='true'] .hamburger::before {
    transform: translateY(7px) rotate(45deg);
  }

  .nav-toggle[aria-expanded='true'] .hamburger::after {
    transform: translateY(-7px) rotate(-45deg);
  }

  /* Primary Navigation */
  .primary-nav {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background-color: var(--color-bg);
    border-bottom: 1px solid var(--color-border);
    box-shadow: var(--shadow-md);
  }

  .primary-nav.is-open {
    display: block;
  }

  .nav-list {
    display: flex;
    flex-direction: column;
    padding: 0;
    list-style: none;
    margin: 0;
  }

  .nav-list li {
    display: flex;
    width: 100%;
    margin: 0;
    padding: 0;
  }

  .nav-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    min-height: 48px;
    padding: var(--spacing-md);
    color: var(--color-text);
    font-weight: 500;
    text-decoration: none;
    transition:
      background-color var(--transition-fast),
      color var(--transition-fast);
  }

  .nav-link:hover {
    background-color: var(--color-bg-secondary);
    color: var(--color-primary);
  }

  .nav-link.is-active {
    color: var(--color-primary);
    background-color: var(--color-bg-secondary);
  }

  /* Button group - mobile first (inside menu at bottom) */
  .nav-buttons {
    display: flex;
    flex-direction: column;
    gap: 0;
    padding: 0;
    border-top: 1px solid var(--color-border);
    margin-top: 0;
  }

  /* Button items styled like nav links on mobile.
     Note: Astro scopes styles to the component they're defined in, so these
     styles only apply to elements rendered directly in this file (e.g. the
     Twitch link). Child components like ThemeToggle must duplicate these
     mobile styles in their own <style> block. Keep them in sync. */
  .nav-button-item {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    width: 100%;
    min-height: 48px;
    color: var(--color-text);
    font-weight: 500;
    text-decoration: none;
    border-radius: 0;
    transition:
      background-color var(--transition-fast),
      color var(--transition-fast);
  }

  .nav-button-item:hover {
    background-color: var(--color-bg-secondary);
    color: var(--color-primary);
  }

  .nav-button-item:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: -2px;
  }

  .nav-button-item svg {
    width: 24px;
    height: 24px;
    flex-shrink: 0;
  }

  .nav-button-text {
    display: block;
  }

  /* Desktop styles */
  @media (min-width: 768px) {
    .nav-toggle {
      display: none;
    }

    .primary-nav {
      display: flex !important; /* Override .is-open state */
      flex-direction: row;
      align-items: center;
      gap: var(--spacing-sm);
      position: static;
      background: transparent;
      border: none;
      box-shadow: none;
    }

    .nav-list {
      flex-direction: row;
      padding: 0;
      gap: var(--spacing-xs);
      align-items: center;
    }

    .nav-list li {
      display: flex;
      align-items: center;
      width: auto;
    }

    .nav-link {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      width: auto;
      height: 44px;
      padding: 0 var(--spacing-md);
      border-radius: var(--border-radius-md);
    }

    .nav-link.is-active {
      background-color: transparent;
      position: relative;
    }

    .nav-link.is-active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: var(--spacing-md);
      right: var(--spacing-md);
      height: 2px;
      background-color: var(--color-primary);
      border-radius: 1px;
    }

    /* Button group on desktop - icon buttons only */
    .nav-buttons {
      flex-direction: row;
      align-items: center;
      gap: var(--spacing-sm);
      border-top: none;
      margin-top: 0;
      padding: 0;
    }

    .nav-button-item {
      width: 44px;
      height: 44px;
      padding: 0;
      justify-content: center;
      gap: 0;
      border-radius: var(--border-radius-md);
    }

    .nav-button-item:focus-visible {
      outline-offset: 2px;
    }

    .nav-button-text {
      display: none;
    }
  }
</style>
